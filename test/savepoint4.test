# 2008 December 15
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
#
# $Id: savepoint4.test,v 1.1 2008/12/19 16:31:12 danielk1977 Exp $

set testdir [file dirname $argv0]
source $testdir/tester.tcl


proc signature {} {
  return [db eval {SELECT count(*), md5sum(x) FROM t3}]
}

expr srand(0)

do_test savepoint4-1 {
  execsql {
    PRAGMA cache_size=10;
    BEGIN;
    CREATE TABLE t3(x TEXT);
    INSERT INTO t3 VALUES(randstr(10,400));
    INSERT INTO t3 VALUES(randstr(10,400));
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    INSERT INTO t3 SELECT randstr(10,400) FROM t3;
    COMMIT;
    SELECT count(*) FROM t3;
  }
} {1024}


unset -nocomplain ::sig

for {set ii 1} {$ii<25} {incr ii} {
  set ::sig [signature]

  set crashed 1
  for {set iDelay 1} {$crashed} {incr iDelay} {
    do_test savepoint4-$ii.1.$iDelay {
      set ret [crashsql -delay $iDelay -file test.db-journal {
        PRAGMA cache_size = 20;
        SAVEPOINT one;
          DELETE FROM t3 WHERE random()%2==0;
          SAVEPOINT two;
            INSERT INTO t3 SELECT randstr(10,10)||x FROM t3;
           ROLLBACK TO two;
            UPDATE t3 SET x = randstr(10, 400) WHERE random()%10;
          RELEASE two;
        ROLLBACK TO one;
      }]
      signature
    } $::sig
    set crashed [lindex $ret 0]
    integrity_check savepoint4-$ii.1.$iDelay.integrity
  }

  do_test savepoint4-$ii.2 {
    execsql {
      DELETE FROM t3 WHERE random()%10==0;
      INSERT INTO t3 SELECT randstr(10,10)||x FROM t3 WHERE random()%9==0;
    }
  } {}
}

finish_test

